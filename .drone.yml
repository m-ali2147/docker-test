---
kind: pipeline
type: ssh
name: ssrunner



server:
  host: 13.49.18.39
  user: ubuntu
  ssh_key:
    from_secret: SSH_PRIVATE_KEY

node:
  repo: ssh

steps:

  - name: configure gcloud
    image: docker.io/kameshsampath/drone-gcloud-auth
    pull: if-not-exists
    settings:
      google_application_credentials:
        from_secret: service_account_json
      google_cloud_project:
        from_secret: google_cloud_project
    commands:
        - gcloud auth activate-service-account --key-file=abc.json
        - gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://asia-south2-docker.pkg.dev


  - name: build-docker-image3
    commands:
      - docker build -t asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/adminer:latest .
      - docker push asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/adminer:latest


  - name: build-docker-image4
    commands:
      - docker build -t asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/postgres:latest .
      - docker push asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/postgres:latest

  - name: build-docker-image2
    commands:
      - docker build -t asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/docker-test_client:latest ./web
      - docker push asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/docker-test_client:latest


  - name: build-docker-image1
    commands:
     - docker build -t asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/docker-test_api:latest ./backend/auth
     - docker push asia-south2-docker.pkg.dev/striking-figure-396805/testgcpdep/docker-test_api:latest


trigger:
  branch:
    only:
      - main

